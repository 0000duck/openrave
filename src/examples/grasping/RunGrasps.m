% RunGrasps(tablefilename)
%
% Load and runs each individual grasp in the OpenRAVE window from a GraspTable file
% generated by MakeXTable

% Copyright (C) 2008 Rosen Diankov (rdiankov@cs.cmu.edu), Dmitry Berenson
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
function RunGrasps(tablefilename,pausetime)

global probs
addopenravepaths_grasping();

load(tablefilename);

if( ~exist('pausetime','var') )
    pausetime = 0.5;
end

orEnvLoadScene('',1); % reset
robot.id = orEnvCreateRobot(robot.name,robot.filename);

Target.name = 'testobject';
Target.id = orEnvCreateKinBody(Target.name,targetfilename);
probs.grasp = orEnvCreateProblem('GrasperProblem', robot.name);

%% run the grasps
grasps = GraspTable;
TargTrans = reshape(orBodyGetLinks(Target.id), [3 4]);
orEnvSetOptions('collision pqp');

for i = 1:size(grasps,1)
    orEnvClose();
    contactsraw = RunGrasp(robot, grasps(i,:), Target,0);
    if( ~isempty(contactsraw) )
        contacts = sscanf(contactsraw,'%f');
        contacts = reshape(contacts, [6 length(contacts)/6]);
        DrawContacts(contacts,0.6);
        disp(sprintf('grasp %d',i));
        pause(pausetime);
    end
end
